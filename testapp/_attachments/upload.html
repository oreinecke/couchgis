<!DOCTYPE html>

<html lang="de">
  <head>
    <title>GeoJSON Upload</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <script src="script/jquery-1.10.2.js"></script>
    <script src="script/jquery.couch.js"></script>
    <script src="script/login_bar.js"></script>

<script>
$(document).ready(function() {
  var GeoJSON, crs, features;
  // write key and value in bold real quick
  var submit=$("#upload :submit");
  $("#upload :file").change(function(e) {
    submit.attr({disabled:true});
    $("#upload b").html("");
    var reader=new FileReader();
    reader.onload=function(evt) {
      try {
        GeoJSON=JSON.parse(evt.target.result);
        if (GeoJSON.type=="FeatureCollection") features=GeoJSON.features;
        else if (GeoJSON.type=="Feature") features=[GeoJSON];
        else throw{message:"Useless GeoJSON type!"};
        crs=GeoJSON.crs;
        if (!crs) throw{message:"No top-level CRS defined!"};
        submit.attr({disabled:false});
        submit.val("Los!");
      } catch(err) {
        $("#upload b").html(err.message+"<br>");
      }
    };
    reader.readAsText(e.target.files[0]);
  });
  $("#upload").submit(function(e) {
    submit.attr({disabled:true});
    var docs=[];
    for (var f=0;f<features.length;f++) {
      var feature=features[f];
      // place properties on top-level
      var doc=feature.properties;
      // and remove useless undefined 
      for (var prop in doc)
        if (doc[prop]==null) doc[prop]=undefined;
      // store geometry as GeoJSON
      doc.GeoJSON=feature.geometry;
      doc.GeoJSON.crs=crs;
      docs.push(doc);
    }
    $.couch.db(window.location.pathname.match(/[^/]+/g)[0]).bulkSave(
      {docs:docs, all_or_nothing:true}, {success:function() {submit.val("Fertig!");} }
    );
    e.preventDefault();
  });
});
</script>

  </head>
  <body>

  <iframe src="login_bar.htm" style="width:100%; height:1.4em; border:0;"></iframe>

  <h1> GeoJSON Upload </h1>
  <form id="upload" action="">
    <input type="file"> <input type="submit" value="Los!" disabled><br>
    <b></b>
  </form>
  </body>
</html>
