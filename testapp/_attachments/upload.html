<!DOCTYPE html>

<html lang="de">
  <head>
    <title>GeoJSON Upload</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link href="css/jquery-ui-1.10.4.custom.css" rel="stylesheet">
    <script src="script/jquery-1.10.2.js"></script>
    <script src="script/jquery-ui-1.10.4.custom.js"></script>
    <script src="script/jquery.couch.js"></script>

<script>
$(document).ready(function() {
  var GeoJSON, crs, features=[];
  var submit=$("#upload :submit");
  var fields={};
  var values={};
  $.getJSON("_view/types-fields?group_level=1", function(data) {
    var source=[];
    while (data.rows.length)
      source.push(data.rows.shift().key);
    $("#modify [name='type']").autocomplete({
      source:source, minLength:0,
      change:function() {$(this).change();}
    });
    $("#modify [name='type']").autocomplete({ source:source, minLength:0 });
  });
  $("#modify [name='type']").change( function() {
    var key=encodeURIComponent(JSON.stringify($(this).val()));
    var source=[
      { label:"Datensatz-Typ", value:"type", mixed:true },
      { label:"Zeitraum", value:"time" }
    ];
    $.getJSON("_view/types-fields?group_level=1&key="+key, function(data) {
      if (data.rows.length) source=source.concat(data.rows[0].value);
      $("#modify [name='field']").autocomplete({
        minLength:0, source:source,
        change:function() {$(this).change();}
      });
    });
  });
  function show_feature(f) {
    $("#modify a").html(f+1);
    var properties=features[f].properties;
    for (var prop in properties)
      values[prop].val(properties[prop]).attr('title', properties[prop]);
  }
  $("#upload :file").change(function(e) {
    $("#modify").hide();
    submit.prop('disabled', true);
    $("#upload b").html("");
    var reader=new FileReader();
    reader.onload=function(evt) {
      try {
        GeoJSON=JSON.parse(evt.target.result);
        if (GeoJSON.type=="FeatureCollection") features=GeoJSON.features;
        else if (GeoJSON.type=="Feature") features=[GeoJSON];
        else throw{message:"Useless GeoJSON type!"};
        crs=GeoJSON.crs;
        if (!crs) throw{message:"No top-level CRS defined!"};
      } catch(err) {
        $("#upload b").html(err.message+"<br>");
        return;
      }
      submit.prop('disabled', false);
      submit.val("Los!");
      var div=$("#modify div");
      fields={};
      values={};
      div.html("");
      // expect all property sets to be identical to the first one
      for (var prop in features[0].properties) {
        var row=$("<span>");
        // render field: value input pair
        var checkbox=$('<input type="checkbox" name="include" checked>');
        var field=$('<input type="text" name="field">');
        var value=$('<input type="text" name="value">');
        row.append(checkbox).append(field).append(': ').append(value).append('<br>');
        // write new value to selected data set
        value.change(function(input, prop) {
          return function() {
            var v=input.val();
            // try to parse new value as number
            try {
              v=JSON.parse(v);
              input.val(v);
            // if that fails just write it as a string
            } catch(e) {}
            features[parseInt($("#modify a").html())-1].properties[prop]=v;
          };
        }(value, prop));
        values[prop]=value;
        field.val(prop);
        fields[prop]=field;
        // disable input fields on row if unchecked
        checkbox.change(function(checkbox, field, value, prop) {
          return function() {
            var disabled=!checkbox.prop('checked');
            field.prop('disabled', disabled);
            value.prop('disabled', disabled);
            // set a nice and helpful tooltip
            var title=prop+' '
            if (disabled) title+='ignorieren';
            else {
              if (field.val()!=prop) title+='als "'+field.val()+'" ';
              title+='übernehmen';
            }
            checkbox.attr({title:title});
          };
        }(checkbox, field, value, prop));
        checkbox.change();
        field.change(function(checkbox) {
          return function() { checkbox.change(); };
        }(checkbox));
        div.append(row);
      }
      show_feature(0);
      $("#modify").show();
    };
    reader.readAsText(e.target.files[0]);
  });
  $("#modify").submit(function(e) {e.preventDefault();});
  // check/uncheck all
  $("#modify [name='all']").change(function() {
    $("#modify [name='include']").prop('checked', $(this).prop('checked'));
    $("#modify [name='include']").change();
  });
  $("#modify [name='prev']").click(function() {
    var f=parseInt($("#modify a").html());
    if (--f<1) f=features.length;
    show_feature(f-1);
  });
  $("#modify [name='next']").click(function() {
    var f=parseInt($("#modify a").html());
    if (++f>features.length) f=1;
    show_feature(f-1);
  });
  $("#upload").submit(function(e) {
    submit.prop('disabled', true);
    var type=$("#modify [name='type']").val();
    var time=$("#modify [name='time']").val();
    var docs=[];
    for (var f=0;f<features.length;f++) {
      var feature=features[f];
      var doc={};
      // set doc-type and time
      doc.type=type;
      doc.time=time;
      // write properties with adjusted labels
      for (var prop in feature.properties) {
        if (fields[prop].prop('disabled')) continue;
        if (fields[prop].val()=="") continue;
        // and ignore useless undefined fields
        if (feature.properties[prop]==null) continue;
        if (feature.properties[prop]=="null") continue;
        if (feature.properties[prop]=="") continue;
        doc[fields[prop].val()]=feature.properties[prop];
      }
      // store geometry as GeoJSON
      doc.GeoJSON=feature.geometry;
      doc.GeoJSON.crs=crs;
      docs.push(doc);
    }
    $.couch.db(window.location.pathname.match(/[^/]+/g)[0]).bulkSave(
      {docs:docs, all_or_nothing:true}, {success:function() {submit.val("Fertig!");} }
    );
    e.preventDefault();
  });
});
</script>

  </head>
  <body>

  <iframe src="login_bar.htm" style="width:100%; height:1.6em; border:0;"></iframe>

  <h1> GeoJSON Upload </h1>
  <form id="upload" action="">
    <input type="file"> <input type="submit" value="Los!" disabled><br>
    <b></b>
  </form>
  <form id="modify" action="" style="display:none">
    Datensatz-Typ: <input type="text" name="type" size="10" value="">
    Zeitraum: <input type="text" name="time" size="15" value="06/2010-10.4.2012"><br>
    <input type="checkbox" name="all" checked> Alle Felder auswählen
    <input type="button" name="prev" value="<">
    Datensatz <a>1</a>
    <input type="button" name="next" value=">">
    <div></div>
    <input type="checkbox" name="all" checked> Alle Felder auswählen
    <input type="button" name="prev" value="<">
    Datensatz <a>1</a>
    <input type="button" name="next" value=">">
  </form>
  </body>
</html>
