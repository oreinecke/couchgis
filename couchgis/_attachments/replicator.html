<!DOCTYPE html>

<html lang="de">
  <head>
    <title>Datenbank-Replikation</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <script src="script/jquery-1.11.1.min.js"></script>
    <script src="script/jquery.couch.js"></script>

<script>
$(document).ready(function() {

  // for now our central couch installation is located here
  var centralhost="http://lsh1908.selfhost.eu:5984";
  // in case I want to rename db/app/replicator.html
  // they are obtained from window.location here
  var parts=window.location.pathname.split('/');
  var db=parts[1];
  var app=parts[2]+'/'+parts[3];
  var page=parts[4];
  $("#localapp").attr({href:"http://localhost:5984/"+db+'/'+app+'/'+page});
  $("#centralapp").attr({href:centralhost+'/'+db+'/'+app+'/'+page});
  if (window.location.hostname==="lsh1908.selfhost.eu") $("div").show();
  else {
    form=$("form");
    form.show();
    form.submit(function (e) {
      var username=$("#replicate :text").val();
      var password=$("#replicate :password").val();
      var login="";
      if (username!="") login=username+'@';
      if (password!="") login=username+':'+password+'@';
      // to be read as 'are we (localhost) the source??'
      var source=($("#replicate [name=mode]:checked").val()==="push");
      // insert username:password@ into centralhost
      var addr={false:centralhost.replace("://","://"+login)+'/'+db, true:db};
      $.couch.replicate(addr[source], addr[!source], {
        success:function(data) {
          $("#replicate :submit").prop('disabled', false);
          // display some replication results
          r=$("#response");
          r.html("")
          // write key and value in bold real quick
          function append(obj, keys) {
            for (var k=0;k<keys.length;k++)
              if (obj[keys[k]]!=null)
                r.append(keys[k]+": <b>"+obj[keys[k]], "</b><br>");
          }
          append(data, ["ok", "no_changes"]);
          if (!data.history || data.no_changes) return;
          // show latest replication history
          append(data.history[0], ["start_time", "end_time",
            "missing_checked", "missing_found", "docs_read",
            "docs_written", "doc_write_failures"]);
        },
        error:function(jqXHR, error) {
          $("#replicate :submit").prop('disabled', false);
          $("#response").html("Fehler: <b>"+error+"</b>");
        }
      }, {
        continuous: $("#replicate :checkbox").prop('checked')
      });
      $("#replicate :submit").prop('disabled', true);
      e.preventDefault();
    });
  }

});
</script>

  </head>
  <body>

  <iframe src="login_bar.htm" style="width:100%; height:1.6em; border:0;"></iframe>

  <h1> Datenbank-Replikation </h1>
  <form style="display:none" id="replicate">
    <input type="radio" value="pull" name="mode" checked> <b>zentrale Daten auf diesen Rechner laden</b> <br>
    <input type="radio" value="push" name="mode"> <b>Daten von hier auf zentrale Datenbank laden</b> <br>
    Benutzername: <input type="text" size="7">
    Kennwort: <input type="password" size="7"><br>
    <input type="checkbox"> Fortlaufend <input type="submit" value="Los!"><br>
    <div id="response"></div>
    <a href="#" id="centralapp">Zur zentralen Datenbank wechseln</a>
  </form>
  <div style="display:none">
    <b>Datenbank-Replikation funktioniert nur vom localhost.</b>
    <ul><li><a href="#" id="localapp">Zur lokalen Datenbank</a>
        <li><a href="http://localhost:5984/_utils/replicator.html">Zum Replikator (Futon)</a>
        <li><a href="http://couchdb.apache.org/">CouchDB installeren</a> </ul>
  </div>
  </body>
</html>
